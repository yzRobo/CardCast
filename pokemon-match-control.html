<!DOCTYPE html>
<html lang="en" data-theme="business">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardCast - Pokemon Match Control</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Minimal custom styles for specific needs */
        .pokemon-card-aspect {
            aspect-ratio: 63/88;
        }
        
        .prize-card-taken {
            opacity: 0.5;
            background: #374151 !important;
        }
        
        .search-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 2rem;
        }
        
        .search-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="min-h-screen bg-base-300">
    <!-- Header -->
    <div class="navbar bg-base-100 shadow-lg fixed top-0 z-40">
        <div class="flex-1">
            <h1 class="text-xl font-bold">CardCast - Pokemon Match Control</h1>
            <a href="/" class="btn btn-ghost btn-sm ml-4">‚Üê Back to Main</a>
        </div>
        <div class="flex-none">
            <div class="badge badge-lg" id="overlayStatus">
                <span class="badge badge-error">Overlay Not Connected</span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 pt-20 pb-8">
        <div class="grid lg:grid-cols-2 gap-6">
            <!-- Player 1 Controls -->
            <div class="card bg-base-100 shadow-xl border-t-4 border-primary">
                <div class="card-body">
                    <h2 class="card-title justify-center">
                        <input type="text" id="player1Name" value="Player 1" 
                               class="input input-ghost text-center text-xl font-bold w-full">
                    </h2>
                    
                    <!-- Active Pokemon -->
                    <div class="divider">Active Pokemon</div>
                    <div class="flex items-center gap-4 p-4 bg-base-200 rounded-lg" id="player1Active">
                        <div class="w-20 h-28 bg-base-300 border-2 border-dashed border-base-content/20 rounded flex items-center justify-center">
                            <span class="text-base-content/50">Empty</span>
                        </div>
                        <div class="flex-1">
                            <button class="btn btn-primary btn-sm" onclick="selectPokemonFor('player1', 'active')">
                                Select Pokemon
                            </button>
                        </div>
                    </div>
                    
                    <!-- HP Control -->
                    <div class="flex items-center gap-2 mt-2">
                        <span class="text-sm">HP:</span>
                        <input type="number" id="player1ActiveHp" class="input input-bordered input-sm w-20" value="0" min="0">
                        <span>/</span>
                        <input type="number" id="player1ActiveMaxHp" class="input input-bordered input-sm w-20" value="0" min="0">
                        <button class="btn btn-sm" onclick="updateActiveHp(1)">Update</button>
                    </div>
                    
                    <!-- Bench -->
                    <div class="divider">Bench</div>
                    <div class="grid grid-cols-5 gap-2" id="player1Bench">
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player1', 'bench', 0)">
                            <span class="text-2xl">+</span>
                        </div>
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player1', 'bench', 1)">
                            <span class="text-2xl">+</span>
                        </div>
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player1', 'bench', 2)">
                            <span class="text-2xl">+</span>
                        </div>
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player1', 'bench', 3)">
                            <span class="text-2xl">+</span>
                        </div>
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player1', 'bench', 4)">
                            <span class="text-2xl">+</span>
                        </div>
                    </div>
                    
                    <!-- Prize Cards -->
                    <div class="divider">Prize Cards</div>
                    <div class="grid grid-cols-6 gap-2" id="player1Prizes">
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(1, 0)">1</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(1, 1)">2</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(1, 2)">3</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(1, 3)">4</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(1, 4)">5</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(1, 5)">6</div>
                    </div>
                    
                    <!-- Game State -->
                    <div class="divider">Game State</div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm">Hand:</label>
                        <input type="number" id="player1Hand" value="7" min="0" class="input input-bordered input-sm w-20">
                        <label class="text-sm">Deck:</label>
                        <input type="number" id="player1Deck" value="47" min="0" class="input input-bordered input-sm w-20">
                        <button class="btn btn-sm" onclick="updatePlayerState(1)">Update</button>
                    </div>
                </div>
            </div>
            
            <!-- Player 2 Controls -->
            <div class="card bg-base-100 shadow-xl border-t-4 border-error">
                <div class="card-body">
                    <h2 class="card-title justify-center">
                        <input type="text" id="player2Name" value="Player 2" 
                               class="input input-ghost text-center text-xl font-bold w-full">
                    </h2>
                    
                    <!-- Active Pokemon -->
                    <div class="divider">Active Pokemon</div>
                    <div class="flex items-center gap-4 p-4 bg-base-200 rounded-lg" id="player2Active">
                        <div class="w-20 h-28 bg-base-300 border-2 border-dashed border-base-content/20 rounded flex items-center justify-center">
                            <span class="text-base-content/50">Empty</span>
                        </div>
                        <div class="flex-1">
                            <button class="btn btn-primary btn-sm" onclick="selectPokemonFor('player2', 'active')">
                                Select Pokemon
                            </button>
                        </div>
                    </div>
                    
                    <!-- HP Control -->
                    <div class="flex items-center gap-2 mt-2">
                        <span class="text-sm">HP:</span>
                        <input type="number" id="player2ActiveHp" class="input input-bordered input-sm w-20" value="0" min="0">
                        <span>/</span>
                        <input type="number" id="player2ActiveMaxHp" class="input input-bordered input-sm w-20" value="0" min="0">
                        <button class="btn btn-sm" onclick="updateActiveHp(2)">Update</button>
                    </div>
                    
                    <!-- Bench -->
                    <div class="divider">Bench</div>
                    <div class="grid grid-cols-5 gap-2" id="player2Bench">
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player2', 'bench', 0)">
                            <span class="text-2xl">+</span>
                        </div>
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player2', 'bench', 1)">
                            <span class="text-2xl">+</span>
                        </div>
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player2', 'bench', 2)">
                            <span class="text-2xl">+</span>
                        </div>
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player2', 'bench', 3)">
                            <span class="text-2xl">+</span>
                        </div>
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player2', 'bench', 4)">
                            <span class="text-2xl">+</span>
                        </div>
                    </div>
                    
                    <!-- Prize Cards -->
                    <div class="divider">Prize Cards</div>
                    <div class="grid grid-cols-6 gap-2" id="player2Prizes">
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(2, 0)">1</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(2, 1)">2</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(2, 2)">3</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(2, 3)">4</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(2, 4)">5</div>
                        <div class="pokemon-card-aspect bg-gradient-to-br from-primary to-secondary rounded cursor-pointer hover:scale-110 transition-transform flex items-center justify-center text-white font-bold"
                             onclick="togglePrize(2, 5)">6</div>
                    </div>
                    
                    <!-- Game State -->
                    <div class="divider">Game State</div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm">Hand:</label>
                        <input type="number" id="player2Hand" value="7" min="0" class="input input-bordered input-sm w-20">
                        <label class="text-sm">Deck:</label>
                        <input type="number" id="player2Deck" value="47" min="0" class="input input-bordered input-sm w-20">
                        <button class="btn btn-sm" onclick="updatePlayerState(2)">Update</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Match Controls -->
        <div class="card bg-base-100 shadow-xl mt-6">
            <div class="card-body">
                <!-- Match Setup -->
                <div class="border-b border-base-300 pb-4">
                    <h3 class="text-sm uppercase tracking-wider text-primary font-semibold mb-3">Match Setup</h3>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Format</span>
                            </label>
                            <select id="matchFormat" class="select select-bordered select-sm">
                                <option value="Best of 1">Best of 1</option>
                                <option value="Best of 3" selected>Best of 3</option>
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-xs">Game</span>
                            </label>
                            <select id="gameNumber" class="select select-bordered select-sm">
                                <option value="1">Game 1</option>
                                <option value="2">Game 2</option>
                                <option value="3">Game 3</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm mt-6" onclick="updateMatchSettings()">Apply Settings</button>
                    </div>
                </div>
                
                <!-- Timer Control -->
                <div class="border-b border-base-300 py-4">
                    <h3 class="text-sm uppercase tracking-wider text-primary font-semibold mb-3">Timer Control</h3>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="text-5xl font-mono font-bold text-primary bg-base-200 px-6 py-3 rounded-lg" id="timerDisplay">50:00</div>
                        <div class="flex gap-2">
                            <button class="btn btn-success" onclick="startTimer()">‚ñ∂ Start</button>
                            <button class="btn btn-warning" onclick="pauseTimer()">‚è∏ Pause</button>
                            <button class="btn btn-neutral" onclick="resetTimer()">‚Ü∫ Reset</button>
                        </div>
                    </div>
                </div>
                
                <!-- Turn Control -->
                <div class="border-b border-base-300 py-4">
                    <h3 class="text-sm uppercase tracking-wider text-primary font-semibold mb-3">Turn Control</h3>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="badge badge-lg badge-primary p-4" id="turnDisplay">Player 1's Turn</div>
                        <button class="btn btn-primary" onclick="switchTurn()">Switch Turn</button>
                    </div>
                </div>
                
                <!-- Overlay Display -->
                <div class="border-b border-base-300 py-4">
                    <h3 class="text-sm uppercase tracking-wider text-primary font-semibold mb-3">Overlay Display</h3>
                    <div class="flex gap-2">
                        <button class="btn btn-success" onclick="showPokemonOverlay()">Show Overlay</button>
                        <button class="btn btn-warning" onclick="hidePokemonOverlay()">Hide Overlay</button>
                    </div>
                </div>
                
                <!-- Match Reset -->
                <div class="pt-4">
                    <h3 class="text-sm uppercase tracking-wider text-primary font-semibold mb-3">Match Reset</h3>
                    <div class="flex items-center gap-4">
                        <button class="btn btn-error" onclick="resetMatch()">üîÑ Reset Entire Match</button>
                        <span class="text-xs text-error opacity-70 italic">This will clear all Pokemon, prizes, and timer</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="card w-full max-w-4xl bg-base-100">
            <div class="card-body">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="card-title">Select Pokemon</h2>
                    <button class="btn btn-circle btn-ghost" onclick="closeSearch()">‚úï</button>
                </div>
                <input type="text" id="pokemonSearch" placeholder="Search Pokemon..." 
                       class="input input-bordered w-full mb-4">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 max-h-96 overflow-y-auto" 
                     id="searchResults">
                    <!-- Search results will appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        let matchState = {
            player1: {
                name: 'Player 1',
                active: null,
                bench: [null, null, null, null, null],
                prizes: [false, false, false, false, false, false],
                hand: 7,
                deck: 47
            },
            player2: {
                name: 'Player 2',
                active: null,
                bench: [null, null, null, null, null],
                prizes: [false, false, false, false, false, false],
                hand: 7,
                deck: 47
            },
            currentTurn: 1,
            timer: { minutes: 50, seconds: 0 },
            timerInterval: null,
            gameNumber: 1,
            matchFormat: 'Best of 3'
        };
        
        let currentSelection = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved state if any
            loadMatchState();
            
            // Setup search
            document.getElementById('pokemonSearch').addEventListener('input', debounce(searchPokemon, 300));
            
            // Update player names on change
            document.getElementById('player1Name').addEventListener('change', updatePlayerNames);
            document.getElementById('player2Name').addEventListener('change', updatePlayerNames);
            
            // Register with server
            socket.emit('register-control', 'pokemon-match');
            
            // Listen for overlay connections
            socket.on('overlay-connected', (type) => {
                if (type === 'pokemon-match') {
                    updateOverlayStatus(true);
                }
            });
            
            socket.on('overlay-disconnected', (type) => {
                if (type === 'pokemon-match') {
                    updateOverlayStatus(false);
                }
            });

            socket.on('connect', () => {
                console.log('Control panel connected to server');
                socket.emit('register-control', 'pokemon-match');
                
                // Request overlay status
                socket.emit('check-overlay-status', 'pokemon-match');
            });
        });
        
        function updateOverlayStatus(connected) {
            const status = document.getElementById('overlayStatus');
            if (connected) {
                status.innerHTML = '<span class="badge badge-success">Overlay Connected</span>';
            } else {
                status.innerHTML = '<span class="badge badge-error">Overlay Not Connected</span>';
            }
        }
        
        function selectPokemonFor(player, slot, benchIndex = null) {
            currentSelection = { player, slot, benchIndex };
            document.getElementById('searchOverlay').classList.add('active');
            document.getElementById('pokemonSearch').focus();
        }
        
        async function searchPokemon(event) {
            const query = event.target.value;
            if (query.length < 2) return;
            
            try {
                const response = await fetch(`/api/search/pokemon?q=${encodeURIComponent(query)}`);
                const results = await response.json();
                displaySearchResults(results);
            } catch (error) {
                console.error('Search error:', error);
            }
        }
        
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = results.map(card => `
                <div class="card bg-base-200 cursor-pointer hover:shadow-lg transition-shadow" 
                     onclick="selectPokemon('${card.id}')">
                    <figure class="px-2 pt-2">
                        <img src="${card.display_image || card.local_image || card.image_url}" 
                             class="rounded-lg pokemon-card-aspect object-cover w-full">
                    </figure>
                    <div class="card-body p-2">
                        <p class="text-xs font-semibold">${card.name}</p>
                        <p class="text-xs opacity-70">HP: ${card.hp || '?'}</p>
                    </div>
                </div>
            `).join('');
        }
        
        async function selectPokemon(cardId) {
            try {
                const response = await fetch(`/api/card/pokemon/${cardId}`);
                const card = await response.json();
                
                const pokemon = {
                    id: card.id,
                    name: card.name,
                    image: card.display_image || card.local_image || card.image_url,
                    maxHp: parseInt(card.hp) || 100,
                    currentHp: parseInt(card.hp) || 100
                };
                
                const playerNum = currentSelection.player === 'player1' ? 1 : 2;
                
                if (currentSelection.slot === 'active') {
                    matchState[currentSelection.player].active = pokemon;
                    updateActiveDisplay(playerNum);
                    socket.emit('active-pokemon', { player: playerNum, pokemon });
                } else if (currentSelection.slot === 'bench') {
                    matchState[currentSelection.player].bench[currentSelection.benchIndex] = pokemon;
                    updateBenchDisplay(playerNum);
                    socket.emit('bench-update', { 
                        player: playerNum, 
                        bench: matchState[currentSelection.player].bench.filter(p => p !== null)
                    });
                }
                
                closeSearch();
                saveMatchState();
            } catch (error) {
                console.error('Error selecting Pokemon:', error);
            }
        }
        
        function updateActiveDisplay(playerNum) {
            const player = matchState[`player${playerNum}`];
            const container = document.getElementById(`player${playerNum}Active`);
            
            if (player.active) {
                container.innerHTML = `
                    <img src="${player.active.image}" class="w-20 h-28 object-cover rounded">
                    <div class="flex-1">
                        <div class="font-bold">${player.active.name}</div>
                        <div class="text-sm opacity-70">HP: ${player.active.currentHp}/${player.active.maxHp}</div>
                        <button class="btn btn-error btn-xs mt-2" onclick="removeActive(${playerNum})">Remove</button>
                    </div>
                `;
                
                document.getElementById(`player${playerNum}ActiveHp`).value = player.active.currentHp;
                document.getElementById(`player${playerNum}ActiveMaxHp`).value = player.active.maxHp;
            } else {
                container.innerHTML = `
                    <div class="w-20 h-28 bg-base-300 border-2 border-dashed border-base-content/20 rounded flex items-center justify-center">
                        <span class="text-base-content/50">Empty</span>
                    </div>
                    <div class="flex-1">
                        <button class="btn btn-primary btn-sm" onclick="selectPokemonFor('player${playerNum}', 'active')">
                            Select Pokemon
                        </button>
                    </div>
                `;
            }
        }
        
        function updateBenchDisplay(playerNum) {
            const player = matchState[`player${playerNum}`];
            const container = document.getElementById(`player${playerNum}Bench`);
            
            container.innerHTML = player.bench.map((pokemon, index) => {
                if (pokemon) {
                    return `
                        <div class="relative group">
                            <img src="${pokemon.image}" class="pokemon-card-aspect object-cover rounded w-full">
                            <button class="btn btn-circle btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                    onclick="removeBench(${playerNum}, ${index})">√ó</button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="pokemon-card-aspect bg-base-300 border-2 border-dashed border-base-content/20 rounded cursor-pointer hover:border-primary transition-colors flex items-center justify-center" 
                             onclick="selectPokemonFor('player${playerNum}', 'bench', ${index})">
                            <span class="text-2xl">+</span>
                        </div>
                    `;
                }
            }).join('');
        }
        
        function removeActive(playerNum) {
            matchState[`player${playerNum}`].active = null;
            updateActiveDisplay(playerNum);
            socket.emit('active-pokemon', { player: playerNum, pokemon: null });
            saveMatchState();
        }
        
        function removeBench(playerNum, index) {
            matchState[`player${playerNum}`].bench[index] = null;
            updateBenchDisplay(playerNum);
            socket.emit('bench-update', { 
                player: playerNum, 
                bench: matchState[`player${playerNum}`].bench.filter(p => p !== null)
            });
            saveMatchState();
        }
        
        function updateActiveHp(playerNum) {
            const currentHp = parseInt(document.getElementById(`player${playerNum}ActiveHp`).value);
            const maxHp = parseInt(document.getElementById(`player${playerNum}ActiveMaxHp`).value);
            
            if (matchState[`player${playerNum}`].active) {
                matchState[`player${playerNum}`].active.currentHp = currentHp;
                matchState[`player${playerNum}`].active.maxHp = maxHp;
                
                socket.emit('active-pokemon', { 
                    player: playerNum, 
                    pokemon: matchState[`player${playerNum}`].active 
                });
                
                updateActiveDisplay(playerNum);
                saveMatchState();
            }
        }
        
        function togglePrize(playerNum, prizeIndex) {
            const prizes = matchState[`player${playerNum}`].prizes;
            prizes[prizeIndex] = !prizes[prizeIndex];
            
            const prizeCard = document.querySelector(`#player${playerNum}Prizes > div:nth-child(${prizeIndex + 1})`);
            if (prizes[prizeIndex]) {
                prizeCard.classList.add('prize-card-taken');
                socket.emit('prize-taken', { player: playerNum, index: prizeIndex });
            } else {
                prizeCard.classList.remove('prize-card-taken');
            }
            
            // Update prize count
            const takenCount = prizes.filter(p => p).length;
            socket.emit('pokemon-match-update', {
                [`player${playerNum}`]: {
                    prizes: 6 - takenCount,
                    prizesTaken: prizes.map((taken, i) => taken ? i : null).filter(i => i !== null)
                }
            });
            
            saveMatchState();
        }
        
        function updatePlayerState(playerNum) {
            const hand = parseInt(document.getElementById(`player${playerNum}Hand`).value);
            const deck = parseInt(document.getElementById(`player${playerNum}Deck`).value);
            
            matchState[`player${playerNum}`].hand = hand;
            matchState[`player${playerNum}`].deck = deck;
            
            socket.emit('pokemon-match-update', {
                [`player${playerNum}`]: {
                    hand: hand,
                    deck: deck
                }
            });
            
            saveMatchState();
        }
        
        function updatePlayerNames() {
            matchState.player1.name = document.getElementById('player1Name').value;
            matchState.player2.name = document.getElementById('player2Name').value;
            
            socket.emit('pokemon-match-update', {
                player1: { name: matchState.player1.name },
                player2: { name: matchState.player2.name }
            });
            
            updateTurnDisplay();
            saveMatchState();
        }
        
        function switchTurn() {
            matchState.currentTurn = matchState.currentTurn === 1 ? 2 : 1;
            socket.emit('turn-switch', { currentTurn: matchState.currentTurn });
            updateTurnDisplay();
            saveMatchState();
        }
        
        function updateTurnDisplay() {
            const playerName = matchState[`player${matchState.currentTurn}`].name;
            document.getElementById('turnDisplay').textContent = `${playerName}'s Turn`;
        }
        
        // Timer functions
        function startTimer() {
            if (matchState.timerInterval) return;
            
            socket.emit('timer-start');
            
            matchState.timerInterval = setInterval(() => {
                if (matchState.timer.seconds > 0) {
                    matchState.timer.seconds--;
                } else if (matchState.timer.minutes > 0) {
                    matchState.timer.minutes--;
                    matchState.timer.seconds = 59;
                } else {
                    pauseTimer();
                }
                updateTimerDisplay();
            }, 1000);
        }
        
        function pauseTimer() {
            if (matchState.timerInterval) {
                clearInterval(matchState.timerInterval);
                matchState.timerInterval = null;
                socket.emit('timer-pause');
            }
        }
        
        function resetTimer() {
            pauseTimer();
            matchState.timer = { minutes: 50, seconds: 0 };
            updateTimerDisplay();
            socket.emit('timer-reset');
            saveMatchState();
        }
        
        function updateTimerDisplay() {
            const minutes = String(matchState.timer.minutes).padStart(2, '0');
            const seconds = String(matchState.timer.seconds).padStart(2, '0');
            document.getElementById('timerDisplay').textContent = `${minutes}:${seconds}`;
        }
        
        function updateMatchSettings() {
            matchState.gameNumber = parseInt(document.getElementById('gameNumber').value);
            matchState.matchFormat = document.getElementById('matchFormat').value;
            
            socket.emit('match-settings', {
                gameNumber: matchState.gameNumber,
                matchFormat: matchState.matchFormat
            });
            
            saveMatchState();
        }
        
        function showPokemonOverlay() {
            socket.emit('toggle-pokemon-match', { show: true });
            console.log('Showing Pokemon overlay');
        }
        
        function hidePokemonOverlay() {
            socket.emit('toggle-pokemon-match', { show: false });
            console.log('Hiding Pokemon overlay');
        }
        
        function resetMatch() {
            if (!confirm('Reset the entire match? This will clear all Pokemon, prizes, and timer.')) {
                return;
            }
            
            matchState = {
                player1: {
                    name: document.getElementById('player1Name').value,
                    active: null,
                    bench: [null, null, null, null, null],
                    prizes: [false, false, false, false, false, false],
                    hand: 7,
                    deck: 47
                },
                player2: {
                    name: document.getElementById('player2Name').value,
                    active: null,
                    bench: [null, null, null, null, null],
                    prizes: [false, false, false, false, false, false],
                    hand: 7,
                    deck: 47
                },
                currentTurn: 1,
                timer: { minutes: 50, seconds: 0 },
                timerInterval: null,
                gameNumber: matchState.gameNumber,
                matchFormat: matchState.matchFormat
            };
            
            // Reset UI
            updateActiveDisplay(1);
            updateActiveDisplay(2);
            updateBenchDisplay(1);
            updateBenchDisplay(2);
            
            // Reset prizes UI
            document.querySelectorAll('#player1Prizes > div, #player2Prizes > div').forEach(card => {
                card.classList.remove('prize-card-taken');
            });
            
            // Reset inputs
            document.getElementById('player1Hand').value = 7;
            document.getElementById('player1Deck').value = 47;
            document.getElementById('player2Hand').value = 7;
            document.getElementById('player2Deck').value = 47;
            
            updateTimerDisplay();
            updateTurnDisplay();
            
            socket.emit('match-reset');
            saveMatchState();
        }
        
        function closeSearch() {
            document.getElementById('searchOverlay').classList.remove('active');
            document.getElementById('pokemonSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            currentSelection = null;
        }
        
        function saveMatchState() {
            localStorage.setItem('pokemonMatchState', JSON.stringify(matchState));
        }
        
        function loadMatchState() {
            const saved = localStorage.getItem('pokemonMatchState');
            if (saved) {
                matchState = JSON.parse(saved);
                
                // Update UI
                document.getElementById('player1Name').value = matchState.player1.name;
                document.getElementById('player2Name').value = matchState.player2.name;
                document.getElementById('player1Hand').value = matchState.player1.hand;
                document.getElementById('player1Deck').value = matchState.player1.deck;
                document.getElementById('player2Hand').value = matchState.player2.hand;
                document.getElementById('player2Deck').value = matchState.player2.deck;
                document.getElementById('gameNumber').value = matchState.gameNumber;
                document.getElementById('matchFormat').value = matchState.matchFormat;
                
                updateActiveDisplay(1);
                updateActiveDisplay(2);
                updateBenchDisplay(1);
                updateBenchDisplay(2);
                
                // Update prizes
                matchState.player1.prizes.forEach((taken, i) => {
                    if (taken) {
                        document.querySelector(`#player1Prizes > div:nth-child(${i + 1})`).classList.add('prize-card-taken');
                    }
                });
                matchState.player2.prizes.forEach((taken, i) => {
                    if (taken) {
                        document.querySelector(`#player2Prizes > div:nth-child(${i + 1})`).classList.add('prize-card-taken');
                    }
                });
                
                updateTimerDisplay();
                updateTurnDisplay();
                
                // Send state to overlays
                socket.emit('pokemon-match-update', {
                    player1: matchState.player1,
                    player2: matchState.player2
                });
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Make functions available globally
        window.selectPokemonFor = selectPokemonFor;
        window.selectPokemon = selectPokemon;
        window.removeActive = removeActive;
        window.removeBench = removeBench;
        window.updateActiveHp = updateActiveHp;
        window.togglePrize = togglePrize;
        window.updatePlayerState = updatePlayerState;
        window.updatePlayerNames = updatePlayerNames;
        window.switchTurn = switchTurn;
        window.startTimer = startTimer;
        window.pauseTimer = pauseTimer;
        window.resetTimer = resetTimer;
        window.updateMatchSettings = updateMatchSettings;
        window.showPokemonOverlay = showPokemonOverlay;
        window.hidePokemonOverlay = hidePokemonOverlay;
        window.resetMatch = resetMatch;
        window.closeSearch = closeSearch;
    </script>
</body>
</html>